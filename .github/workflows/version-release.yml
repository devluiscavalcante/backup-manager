name: Version Release Automation

on:
    push:
      tags: [ 'v*.*.*' ]
    workflow_dispatch:
      inputs:
        release_version:
          description: 'Release version (format: v1.0.0)'
          required: true
          default: 'v1.0.0'
          type: string

permissions:
    contents: write

jobs:
    create-release:
      name: Create GitHub Release
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            java-version: '21'
            distribution: 'temurin'

        - name: Build Release Artifacts
          run: |
            mvn clean package -DskipTests
            echo "JAR file:"
            ls -lh target/*.jar

        - name: Get Version from Tag
          id: get_version
          run: |
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "version=${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
            else
              echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            fi
            echo "Releasing version: ${{ steps.get_version.outputs.version }}"

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: ${{ steps.get_version.outputs.version }}
            name: Release ${{ steps.get_version.outputs.version }}
            draft: false
            prerelease: false
            files: |
              target/*.jar
            generate_release_notes: true

        - name: Success
          run: |
            echo "Release ${{ steps.get_version.outputs.version }} created!"
            echo "Download: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
            echo "Docker: ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }}"
